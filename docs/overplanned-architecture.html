<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Overplanned — System Architecture</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;0,500;1,400&family=Sora:wght@300;400;500;600;700&display=swap');

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0f0d0b;
    --surface: #1a1612;
    --surface2: #221e19;
    --border: #2e2820;
    --border-bright: #4a3f32;
    --terra: #c8623a;
    --terra-dim: rgba(200, 98, 58, 0.15);
    --terra-glow: rgba(200, 98, 58, 0.06);
    --amber: #d4913d;
    --sage: #7a9e7e;
    --blue: #5b8db8;
    --violet: #8b7ab8;
    --muted: #6b6057;
    --text: #e8ddd4;
    --text-dim: #9e9088;
    --text-faint: #5a5048;
    --pipe: rgba(200, 98, 58, 0.4);
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Sora', sans-serif;
    min-height: 100vh;
    padding: 48px 32px;
    overflow-x: hidden;
  }

  /* HEADER */
  header {
    display: flex;
    align-items: baseline;
    gap: 20px;
    margin-bottom: 56px;
  }
  .wordmark {
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    font-weight: 500;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--terra);
  }
  .doc-title {
    font-size: 13px;
    color: var(--text-faint);
    font-family: 'DM Mono', monospace;
  }
  .doc-date {
    font-size: 11px;
    color: var(--text-faint);
    font-family: 'DM Mono', monospace;
    margin-left: auto;
  }

  /* DIAGRAM CONTAINER */
  .diagram {
    display: grid;
    grid-template-columns: 1fr;
    gap: 0;
    max-width: 1200px;
    margin: 0 auto;
  }

  /* LAYERS */
  .layer {
    display: grid;
    grid-template-columns: 100px 1fr;
    gap: 0;
    min-height: 0;
  }

  .layer-label {
    writing-mode: vertical-rl;
    transform: rotate(180deg);
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--text-faint);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 16px 0;
    border-right: 1px solid var(--border);
    margin-right: 0;
  }

  .layer-content {
    padding: 20px 0 20px 28px;
    border-bottom: 1px solid var(--border);
  }

  .layer:last-child .layer-content {
    border-bottom: none;
  }

  /* ROW WITHIN LAYER */
  .row {
    display: flex;
    align-items: stretch;
    gap: 12px;
    flex-wrap: wrap;
  }

  .row + .row {
    margin-top: 12px;
  }

  /* NODE CARDS */
  .node {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 14px 16px;
    min-width: 140px;
    flex: 1;
    position: relative;
    transition: border-color 0.2s;
  }
  .node:hover { border-color: var(--border-bright); }

  .node.accent {
    border-color: rgba(200, 98, 58, 0.3);
    background: var(--terra-glow);
  }
  .node.accent:hover { border-color: var(--terra); }

  .node.amber {
    border-color: rgba(212, 145, 61, 0.25);
    background: rgba(212, 145, 61, 0.04);
  }
  .node.sage {
    border-color: rgba(122, 158, 126, 0.25);
    background: rgba(122, 158, 126, 0.04);
  }
  .node.blue {
    border-color: rgba(91, 141, 184, 0.25);
    background: rgba(91, 141, 184, 0.04);
  }
  .node.violet {
    border-color: rgba(139, 122, 184, 0.25);
    background: rgba(139, 122, 184, 0.04);
  }

  .node-tag {
    font-family: 'DM Mono', monospace;
    font-size: 9px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--text-faint);
    margin-bottom: 6px;
  }
  .node-tag.terra { color: var(--terra); }
  .node-tag.amber { color: var(--amber); }
  .node-tag.sage { color: var(--sage); }
  .node-tag.blue { color: var(--blue); }
  .node-tag.violet { color: var(--violet); }

  .node-name {
    font-size: 13px;
    font-weight: 600;
    color: var(--text);
    line-height: 1.2;
    margin-bottom: 8px;
  }

  .node-detail {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    color: var(--text-dim);
    line-height: 1.6;
  }

  .node-detail .highlight {
    color: var(--text);
  }

  /* ARROWS / FLOW SECTION */
  .flow-connector {
    display: flex;
    align-items: center;
    padding: 0 0 0 128px;
    height: 36px;
    position: relative;
  }

  .flow-line {
    flex: 1;
    height: 1px;
    background: linear-gradient(90deg, var(--pipe), transparent);
    position: relative;
    max-width: 600px;
  }

  .flow-label {
    font-family: 'DM Mono', monospace;
    font-size: 9px;
    color: var(--muted);
    letter-spacing: 0.08em;
    margin: 0 16px;
    white-space: nowrap;
  }

  /* FLOW ARROWS between layers */
  .inter-layer-flow {
    display: flex;
    padding: 0 0 0 100px;
    height: 44px;
    align-items: center;
    gap: 0;
    border-left: 1px solid var(--border);
  }

  .arrow-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
    padding-left: 28px;
  }

  .arrow-item {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .arrow-line {
    width: 40px;
    height: 1px;
    background: var(--pipe);
    position: relative;
  }
  .arrow-line::after {
    content: '';
    position: absolute;
    right: -1px;
    top: -3px;
    border: 3px solid transparent;
    border-left-color: var(--terra);
    border-right: none;
  }
  .arrow-label {
    font-family: 'DM Mono', monospace;
    font-size: 9px;
    color: var(--muted);
    letter-spacing: 0.06em;
  }

  /* PIPELINE BANNER */
  .pipeline-banner {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-left: 3px solid var(--terra);
    padding: 10px 16px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 12px;
    border-radius: 0 4px 4px 0;
  }
  .pipeline-banner.amber { border-left-color: var(--amber); }
  .pipeline-banner.sage { border-left-color: var(--sage); }
  .pipeline-banner.blue { border-left-color: var(--blue); }

  .pipeline-id {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    color: var(--terra);
    font-weight: 500;
    white-space: nowrap;
  }
  .pipeline-id.amber { color: var(--amber); }
  .pipeline-id.sage { color: var(--sage); }
  .pipeline-id.blue { color: var(--blue); }

  .pipeline-desc {
    font-size: 11px;
    color: var(--text-dim);
    font-family: 'DM Mono', monospace;
  }

  /* SPECIAL: ML evolution track */
  .evolution-track {
    display: flex;
    align-items: center;
    gap: 0;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    overflow: hidden;
    flex: 1;
  }
  .evo-step {
    flex: 1;
    padding: 10px 12px;
    border-right: 1px solid var(--border);
    position: relative;
  }
  .evo-step:last-child { border-right: none; }
  .evo-step.active {
    background: var(--terra-glow);
    border-color: rgba(200,98,58,0.3);
  }
  .evo-label {
    font-family: 'DM Mono', monospace;
    font-size: 9px;
    color: var(--text-faint);
    margin-bottom: 4px;
  }
  .evo-name {
    font-size: 11px;
    font-weight: 600;
    color: var(--text-dim);
  }
  .evo-step.active .evo-name { color: var(--terra); }
  .evo-arrow {
    width: 0;
    height: 0;
    border-top: 6px solid transparent;
    border-bottom: 6px solid transparent;
    border-left: 6px solid var(--border);
    flex-shrink: 0;
    z-index: 1;
    margin: 0 -1px;
  }

  /* SIGNAL TAGS */
  .signal-list {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 8px;
  }
  .signal-tag {
    font-family: 'DM Mono', monospace;
    font-size: 9px;
    color: var(--text-faint);
    border: 1px solid var(--border);
    border-radius: 2px;
    padding: 2px 6px;
    letter-spacing: 0.04em;
  }
  .signal-tag.hot { color: var(--terra); border-color: rgba(200,98,58,0.3); }
  .signal-tag.warm { color: var(--amber); border-color: rgba(212,145,61,0.3); }
  .signal-tag.cool { color: var(--blue); border-color: rgba(91,141,184,0.3); }

  /* LEGEND */
  .legend {
    display: flex;
    gap: 24px;
    margin-top: 40px;
    padding-top: 24px;
    border-top: 1px solid var(--border);
    flex-wrap: wrap;
  }
  .legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    color: var(--text-faint);
  }
  .legend-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--terra);
    flex-shrink: 0;
  }
  .legend-dot.amber { background: var(--amber); }
  .legend-dot.sage { background: var(--sage); }
  .legend-dot.blue { background: var(--blue); }
  .legend-dot.violet { background: var(--violet); }

  /* VERTICAL PIPE: connects pipelines column */
  .big-flow {
    display: grid;
    grid-template-columns: 100px 1fr;
  }
  .vert-pipe-col {
    border-right: 1px solid var(--border);
  }

  /* SECTION DIVIDER */
  .section-sep {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 12px 0 12px 100px;
    border-left: 1px solid var(--border);
  }
  .sep-line {
    flex: 1;
    height: 1px;
    background: var(--border);
    max-width: 400px;
  }
  .sep-label {
    font-family: 'DM Mono', monospace;
    font-size: 9px;
    color: var(--text-faint);
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }

  /* SPECIAL: big data flow arrows spanning layers */
  .side-annotations {
    position: fixed;
    right: 32px;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    flex-direction: column;
    gap: 24px;
    opacity: 0.6;
  }

  @media (max-width: 900px) {
    .side-annotations { display: none; }
    body { padding: 24px 16px; }
    .layer { grid-template-columns: 60px 1fr; }
    .flow-connector { padding-left: 88px; }
    .inter-layer-flow { padding-left: 60px; }
    .section-sep { padding-left: 60px; }
  }

  /* SUBTLE GRAIN */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 1000;
    opacity: 0.4;
  }
</style>
</head>
<body>

<header>
  <span class="wordmark">Overplanned</span>
  <span class="doc-title">/ system architecture</span>
  <span class="doc-date">Feb 2026 — internal</span>
</header>

<div class="diagram">

  <!-- ═══════════════════════════════════════════════════════ -->
  <!-- LAYER 1: DATA SOURCES (INGEST) -->
  <!-- ═══════════════════════════════════════════════════════ -->
  <div class="layer">
    <div class="layer-label">Sources</div>
    <div class="layer-content">
      <div class="pipeline-banner">
        <span class="pipeline-id">Pipeline C — World Knowledge Ingest</span>
        <span class="pipeline-desc">scrape → extract → score → store ActivityNodes</span>
      </div>
      <div class="row">
        <div class="node accent">
          <div class="node-tag terra">Tier 1 · highest signal</div>
          <div class="node-name">Reddit / Forums</div>
          <div class="node-detail">
            PRAW API + Pushshift<br>
            r/JapanTravel, r/solotravel<br>
            city subs, 2ch, 5ch, DC<br>
            <span class="highlight">→ overrated signal, local override</span>
          </div>
        </div>
        <div class="node accent">
          <div class="node-tag terra">Tier 1 · local platforms</div>
          <div class="node-name">Tabelog / Naver / Dianping</div>
          <div class="node-detail">
            Rate-limited scrape<br>
            JP, KR, CN food + activity<br>
            <span class="highlight">→ local vs tourist divergence</span>
          </div>
        </div>
        <div class="node">
          <div class="node-tag">Tier 1 · curated</div>
          <div class="node-name">Travel Blogs</div>
          <div class="node-detail">
            RSS + periodic crawl<br>
            30–50 seed blogs / region<br>
            <span class="highlight">→ hidden gem consensus</span>
          </div>
        </div>
        <div class="node">
          <div class="node-tag">Tier 2</div>
          <div class="node-name">Atlas Obscura</div>
          <div class="node-detail">
            Structured API<br>
            weird / off-the-beaten<br>
            <span class="highlight">→ specificity score</span>
          </div>
        </div>
        <div class="node">
          <div class="node-tag">Tier 2 · fallback</div>
          <div class="node-name">Google Places API</div>
          <div class="node-detail">
            Hours, coords, photos<br>
            Cached permanently<br>
            <span class="highlight">→ metadata only, not signal</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- FLOW: Sources → Extraction -->
  <div class="inter-layer-flow">
    <div class="arrow-group">
      <div class="arrow-item">
        <div class="arrow-line"></div>
        <span class="arrow-label">raw HTML / JSON / API responses → batch LLM extraction (Claude Haiku)</span>
      </div>
      <div class="arrow-item">
        <div class="arrow-line"></div>
        <span class="arrow-label">SHA256 content hash → vibe_extraction_cache (no re-inference on repeat scrapes)</span>
      </div>
    </div>
  </div>

  <!-- ═══════════════════════════════════════════════════════ -->
  <!-- LAYER 2: EXTRACTION + TAGGING -->
  <!-- ═══════════════════════════════════════════════════════ -->
  <div class="layer">
    <div class="layer-label">Extraction</div>
    <div class="layer-content">
      <div class="row">
        <div class="node amber">
          <div class="node-tag amber">LLM Batch (pre-launch)</div>
          <div class="node-name">Vibe Tag Extractor</div>
          <div class="node-detail">
            Claude Haiku · batch pricing<br>
            ~$40 one-time per region<br>
            Input: raw community text<br>
            Output: 42-tag vibe vocabulary<br>
            <span class="highlight">Stored → reused forever</span>
          </div>
        </div>
        <div class="node">
          <div class="node-tag">ML (Month 5+)</div>
          <div class="node-name">Vibe Tagger MLP</div>
          <div class="node-detail">
            Distilled from LLM labels<br>
            sentence-transformers → 64-dim<br>
            ~&lt;10ms CPU inference<br>
            <span class="highlight">LLM as teacher → MLP student</span>
          </div>
        </div>
        <div class="node">
          <div class="node-tag">Deterministic</div>
          <div class="node-name">Category Vibe Map</div>
          <div class="node-detail">
            "ramen" → [casual, locals-only]<br>
            "kaiseki" → [splurge, slow-burn]<br>
            ~70% coverage at $0<br>
            <span class="highlight">Always-on fallback</span>
          </div>
        </div>
        <div class="node">
          <div class="node-tag">Scorer</div>
          <div class="node-name">Cross-Ref Confidence</div>
          <div class="node-detail">
            Multi-source agreement<br>
            tourist_score scalar<br>
            quality_signals JSONB<br>
            <span class="highlight">"Overrated Detector"</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- FLOW: Extraction → DB -->
  <div class="inter-layer-flow">
    <div class="arrow-group">
      <div class="arrow-item">
        <div class="arrow-line"></div>
        <span class="arrow-label">ActivityNode upsert: vibe_tags, vibe_confidence, quality_signals, tourist_score</span>
      </div>
      <div class="arrow-item">
        <div class="arrow-line"></div>
        <span class="arrow-label">64-dim vibe_embedding → Postgres (authoritative) + Qdrant (search index)</span>
      </div>
    </div>
  </div>

  <!-- ═══════════════════════════════════════════════════════ -->
  <!-- LAYER 3: DATA STORES -->
  <!-- ═══════════════════════════════════════════════════════ -->
  <div class="layer">
    <div class="layer-label">Data Layer</div>
    <div class="layer-content">
      <div class="row">
        <div class="node blue" style="flex: 2;">
          <div class="node-tag blue">Postgres · Cloud SQL · permanent</div>
          <div class="node-name">PostgreSQL</div>
          <div class="node-detail">
            activity_nodes — 50K records, vibe_embedding VECTOR(64)<br>
            users, persona_snapshots, behavioral_signals<br>
            places_api_cache, vibe_extraction_cache<br>
            group_trips, itineraries, pivot_events<br>
            model_registry — versioned ML artifacts<br>
            <span class="highlight">System of record. Write once, read forever.</span>
          </div>
        </div>
        <div class="node blue">
          <div class="node-tag blue">Qdrant · self-hosted · search index</div>
          <div class="node-name">Qdrant</div>
          <div class="node-detail">
            64-dim vibe embeddings<br>
            HNSW graph index<br>
            ANN search &lt;2ms<br>
            $8/mo @ 50K nodes<br>
            <span class="highlight">Rebuilt from Postgres anytime.</span>
          </div>
        </div>
        <div class="node">
          <div class="node-tag">Redis · Memorystore · TTL cache</div>
          <div class="node-name">Redis</div>
          <div class="node-detail">
            LLM narratives: 30d TTL<br>
            Ranked candidate sets<br>
            User persona (session)<br>
            Pre-warmed: 45 combos<br>
            <span class="highlight">Derived only — reconstructable.</span>
          </div>
        </div>
        <div class="node">
          <div class="node-tag">GCS · object store</div>
          <div class="node-name">Cloud Storage</div>
          <div class="node-detail">
            Activity photos (~80KB avg)<br>
            Raw scraped HTML / JSON<br>
            Training data Parquet<br>
            ML model artifacts<br>
            <span class="highlight">~$0.08/mo at 50K nodes</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SECTION BREAK -->
  <div class="section-sep">
    <div class="sep-line"></div>
    <span class="sep-label">↑ world knowledge · user data ↓</span>
    <div class="sep-line"></div>
  </div>

  <!-- ═══════════════════════════════════════════════════════ -->
  <!-- LAYER 4: ML PIPELINES A + B -->
  <!-- ═══════════════════════════════════════════════════════ -->
  <div class="layer">
    <div class="layer-label">ML Pipelines</div>
    <div class="layer-content">

      <div class="pipeline-banner">
        <span class="pipeline-id">Pipeline A — User Understanding</span>
        <span class="pipeline-desc">behavioral signals → persona embedding (64-dim)</span>
      </div>

      <div class="row" style="margin-bottom: 20px;">
        <div class="node">
          <div class="node-tag">implicit signals · high volume</div>
          <div class="node-name">Behavioral Ingestion</div>
          <div class="node-detail">
            Pivot: accept / dismiss / ignore<br>
            Completion: GPS / check-in<br>
            Slot modification, dwell time<br>
            Poll vote, scroll skip
            <div class="signal-list">
              <span class="signal-tag hot">pivot_event</span>
              <span class="signal-tag warm">completion</span>
              <span class="signal-tag cool">scroll</span>
            </div>
          </div>
        </div>
        <div class="node accent">
          <div class="node-tag terra">nightly job</div>
          <div class="node-name">Persona Updater</div>
          <div class="node-detail">
            behavioral_signals → training Parquet<br>
            Persona dims: pace, food, energy...<br>
            Updated snapshot → Postgres<br>
            <span class="highlight">Mid-trip signals weighted 3×</span>
          </div>
        </div>
        <div class="node">
          <div class="node-tag">Group dynamics</div>
          <div class="node-name">Group Affinity Model</div>
          <div class="node-detail">
            Individual vecs → merged group vec<br>
            Conflict surface detection<br>
            Deletion: anonymize, not purge<br>
            <span class="highlight">Separate privacy consent flow</span>
          </div>
        </div>
      </div>

      <div class="pipeline-banner amber">
        <span class="pipeline-id amber">Pipeline B — Recommendation Ranking</span>
        <span class="pipeline-desc">user embedding × item embeddings → scored, ranked, narrated candidates</span>
      </div>

      <div class="row">
        <!-- ML Evolution Track -->
        <div style="flex: 1; min-width: 600px;">
          <div class="node-tag" style="margin-bottom: 8px; font-family: 'DM Mono', monospace; font-size: 9px; letter-spacing: 0.12em; text-transform: uppercase; color: var(--text-faint);">Model evolution — each phase clears a promotion gate before replacing the prior</div>
          <div class="evolution-track">
            <div class="evo-step active">
              <div class="evo-label">Month 0 → live now</div>
              <div class="evo-name">LLM Ranker</div>
              <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--text-faint);margin-top:4px;">Haiku · structured signals in<br>ranked list out · logs all</div>
            </div>
            <div class="evo-arrow"></div>
            <div class="evo-step">
              <div class="evo-label">Month 5 · warm users</div>
              <div class="evo-name">BPR Model</div>
              <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--text-faint);margin-top:4px;">Bayesian Personalized Ranking<br>accept vs skip pairs</div>
            </div>
            <div class="evo-arrow"></div>
            <div class="evo-step">
              <div class="evo-label">Month 9 · warm users</div>
              <div class="evo-name">Two-Tower</div>
              <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--text-faint);margin-top:4px;">User tower + Item tower<br>ANN via Qdrant</div>
            </div>
            <div class="evo-arrow"></div>
            <div class="evo-step">
              <div class="evo-label">Month 12+ · dense graph</div>
              <div class="evo-name">LightGCN</div>
              <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--text-faint);margin-top:4px;">Graph neural net<br>10K edge threshold</div>
            </div>
          </div>
        </div>
        <div class="node sage" style="min-width: 160px; max-width: 220px;">
          <div class="node-tag sage">LLM always-on</div>
          <div class="node-name">Narration Layer</div>
          <div class="node-detail">
            ML scores → ranked list<br>
            LLM converts to natural language<br>
            Cache key: (activity_id, archetype, day_part)<br>
            <span class="highlight">Popular cities → ~$0</span>
          </div>
        </div>
      </div>

      <!-- Shadow Mode callout -->
      <div style="margin-top: 12px; padding: 10px 14px; border: 1px solid var(--border); border-left: 2px solid var(--amber); background: rgba(212,145,61,0.04); border-radius: 0 4px 4px 0;">
        <span style="font-family:'DM Mono',monospace;font-size:9px;color:var(--amber);text-transform:uppercase;letter-spacing:0.1em;">Shadow Mode — </span>
        <span style="font-family:'DM Mono',monospace;font-size:9px;color:var(--text-dim);">Candidate model computes ranking in parallel but does NOT serve. Runs 2–4 weeks. Promotion gate: new model HR@5 CI lower bound must exceed LLM CI upper bound. No overlap = promote.</span>
      </div>
    </div>
  </div>

  <!-- FLOW: ML → API -->
  <div class="inter-layer-flow">
    <div class="arrow-group">
      <div class="arrow-item">
        <div class="arrow-line"></div>
        <span class="arrow-label">ranked + narrated candidates → API server · X-Model-Version header logged per response</span>
      </div>
      <div class="arrow-item">
        <div class="arrow-line"></div>
        <span class="arrow-label">pre-warmed: 45 cache combos (3 archetypes × 3 day_parts × 5 days) async at trip creation</span>
      </div>
    </div>
  </div>

  <!-- ═══════════════════════════════════════════════════════ -->
  <!-- LAYER 5: API SERVER -->
  <!-- ═══════════════════════════════════════════════════════ -->
  <div class="layer">
    <div class="layer-label">Server</div>
    <div class="layer-content">
      <div class="row">
        <div class="node accent">
          <div class="node-tag terra">Cloud Run · autoscale</div>
          <div class="node-name">API Server</div>
          <div class="node-detail">
            Trip generation endpoint<br>
            Itinerary CRUD<br>
            Persona read / behavioral write<br>
            Group sync, poll resolution<br>
            <span class="highlight">$28/mo · 2 baseline instances</span>
          </div>
        </div>
        <div class="node">
          <div class="node-tag">Cloud Run · workers</div>
          <div class="node-name">Background Workers</div>
          <div class="node-detail">
            Scrape scheduler (cron)<br>
            Nightly training data extractor<br>
            Cache pre-warmer<br>
            ML shadow mode runner<br>
            <span class="highlight">Async queue via Cloud Tasks</span>
          </div>
        </div>
        <div class="node">
          <div class="node-tag">Real-time · WebSocket</div>
          <div class="node-name">Pivot Engine</div>
          <div class="node-detail">
            5 trigger types monitored<br>
            Pre-cached fallback graph<br>
            Selective re-solve (not full day)<br>
            Cascade eval: 3+ slots = prompt<br>
            <span class="highlight">&lt;2s venue/weather · &lt;3s mood</span>
          </div>
        </div>
        <div class="node">
          <div class="node-tag">Cache layer</div>
          <div class="node-name">Cache Hierarchy</div>
          <div class="node-detail">
            L1: LLM Narrative (Redis 30d)<br>
            L2: Ranking (Redis, proactive)<br>
            L3: Candidate set (Redis)<br>
            L4: Places API (Postgres)<br>
            L5: Vibe extraction (Postgres)<br>
            L6: Itinerary assembly (compute)
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- FLOW: Server → Client -->
  <div class="inter-layer-flow">
    <div class="arrow-group">
      <div class="arrow-item">
        <div class="arrow-line"></div>
        <span class="arrow-label">REST + WebSocket → Next.js frontend (web-first) → iOS later</span>
      </div>
      <div class="arrow-item">
        <div class="arrow-line"></div>
        <span class="arrow-label">PivotEvent stream (real-time) · behavioral_signals write-back (async)</span>
      </div>
    </div>
  </div>

  <!-- ═══════════════════════════════════════════════════════ -->
  <!-- LAYER 6: FRONTEND -->
  <!-- ═══════════════════════════════════════════════════════ -->
  <div class="layer">
    <div class="layer-label">Frontend</div>
    <div class="layer-content">
      <div class="row">
        <div class="node">
          <div class="node-tag">Onboarding</div>
          <div class="node-name">Trip DNA</div>
          <div class="node-detail">
            "Plan a trip" / "Show me something"<br>
            9 tag sections · contextual not demo<br>
            Pace, Food, Mornings, Nights...<br>
            <span class="highlight">Seeds cold-start persona</span>
          </div>
        </div>
        <div class="node accent">
          <div class="node-tag terra">Core experience</div>
          <div class="node-name">Itinerary View</div>
          <div class="node-detail">
            Slot-based day view<br>
            ActivityNode card per slot<br>
            Thumbs: optional, one-time, 4s timeout<br>
            <span class="highlight">Implicit > explicit signal</span>
          </div>
        </div>
        <div class="node">
          <div class="node-tag">Real-time</div>
          <div class="node-name">Pivot Drawer</div>
          <div class="node-detail">
            System + user-initiated = same UI<br>
            2 adjacent + 1 polar + 1 indoor alt<br>
            Accept / dismiss / ignore all logged<br>
            <span class="highlight">PivotEvent → Pipeline A immediately</span>
          </div>
        </div>
        <div class="node">
          <div class="node-tag">Group</div>
          <div class="node-name">Group Planning</div>
          <div class="node-detail">
            Invite flow · poll surfaces<br>
            Group vec = merged persona vecs<br>
            Conflict surfacing UI<br>
            <span class="highlight">Separate privacy consent</span>
          </div>
        </div>
        <div class="node">
          <div class="node-tag">Post-trip</div>
          <div class="node-name">Memory / Retention</div>
          <div class="node-detail">
            Trip rating → highest-quality signal<br>
            Photo moments<br>
            Feeds next trip persona<br>
            <span class="highlight">Retention loop stub (TBD)</span>
          </div>
        </div>
      </div>
    </div>
  </div>

</div><!-- end diagram -->

<!-- FEEDBACK LOOP ANNOTATION -->
<div style="max-width:1200px;margin:0 auto;margin-top:0;padding: 0 0 0 100px;border-left:1px solid var(--border);">
  <div style="padding:20px 28px;border-top:1px solid var(--border);">
    <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--terra);letter-spacing:0.12em;text-transform:uppercase;margin-bottom:12px;">Feedback Loop — every user action feeds upstream</div>
    <div style="display:flex;align-items:center;gap:0;flex-wrap:wrap;background:var(--surface);border:1px solid var(--border);border-radius:4px;overflow:hidden;">
      <div style="padding:10px 16px;flex:1;min-width:120px;border-right:1px solid var(--border);">
        <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--text-faint);">User action</div>
        <div style="font-size:11px;font-weight:600;color:var(--text);margin-top:2px;">Accept pivot</div>
      </div>
      <div style="padding:0 8px;color:var(--terra);font-family:'DM Mono',monospace;font-size:12px;">→</div>
      <div style="padding:10px 16px;flex:1;min-width:120px;border-right:1px solid var(--border);">
        <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--text-faint);">PivotEvent log</div>
        <div style="font-size:11px;font-weight:600;color:var(--text);margin-top:2px;">behavioral_signals</div>
      </div>
      <div style="padding:0 8px;color:var(--terra);font-family:'DM Mono',monospace;font-size:12px;">→</div>
      <div style="padding:10px 16px;flex:1;min-width:120px;border-right:1px solid var(--border);">
        <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--text-faint);">Nightly job</div>
        <div style="font-size:11px;font-weight:600;color:var(--text);margin-top:2px;">Training Parquet</div>
      </div>
      <div style="padding:0 8px;color:var(--terra);font-family:'DM Mono',monospace;font-size:12px;">→</div>
      <div style="padding:10px 16px;flex:1;min-width:120px;border-right:1px solid var(--border);">
        <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--text-faint);">Pipeline A</div>
        <div style="font-size:11px;font-weight:600;color:var(--text);margin-top:2px;">Persona update</div>
      </div>
      <div style="padding:0 8px;color:var(--terra);font-family:'DM Mono',monospace;font-size:12px;">→</div>
      <div style="padding:10px 16px;flex:1;min-width:120px;border-right:1px solid var(--border);">
        <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--text-faint);">Pipeline B shadow</div>
        <div style="font-size:11px;font-weight:600;color:var(--text);margin-top:2px;">Model eval</div>
      </div>
      <div style="padding:0 8px;color:var(--terra);font-family:'DM Mono',monospace;font-size:12px;">→</div>
      <div style="padding:10px 16px;flex:1;min-width:120px;">
        <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--text-faint);">On promotion</div>
        <div style="font-size:11px;font-weight:600;color:var(--terra);margin-top:2px;">Better recs</div>
      </div>
    </div>
  </div>
</div>

<!-- LEGEND + COST -->
<div style="max-width:1200px;margin:0 auto;padding:0 0 0 128px;">
  <div class="legend">
    <div class="legend-item"><div class="legend-dot"></div>Pipeline C / World Knowledge</div>
    <div class="legend-item"><div class="legend-dot amber"></div>ML Ranking evolution</div>
    <div class="legend-item"><div class="legend-dot sage"></div>LLM narration (always-on)</div>
    <div class="legend-item"><div class="legend-dot blue"></div>Permanent storage</div>
    <div class="legend-item"><div class="legend-dot violet"></div>TTL cache</div>
    <div style="margin-left:auto;font-family:'DM Mono',monospace;font-size:10px;color:var(--text-faint);">
      infra total: ~$90–115/mo @ 500 MAU &nbsp;·&nbsp; LLM ranking: ~$2.40/mo &nbsp;·&nbsp; grows to ~$350–450 @ 5K MAU
    </div>
  </div>
</div>

</body>
</html>
